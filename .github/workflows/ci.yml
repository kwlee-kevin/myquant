name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  pull-requests: write

jobs:
  docs-gate:
    name: docs-gate
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Enforce docs updates for code changes
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.info("No pull_request context. Skipping docs gate.");
              return;
            }

            const codePrefixes = [
              "backend/",
              "bridge/",
              "frontend/",
              "scripts/",
              ".github/workflows/",
            ];
            const docPrefixes = [
              "docs/",
            ];
            const docFiles = new Set([
              "README.md",
              ".github/pull_request_template.md",
            ]);

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              per_page: 100,
            });

            const changed = files.map((f) => f.filename);
            const codeChanged = changed.filter((path) =>
              codePrefixes.some((prefix) => path.startsWith(prefix))
            );
            const docChanged = changed.filter(
              (path) =>
                docPrefixes.some((prefix) => path.startsWith(prefix)) || docFiles.has(path)
            );

            const labels = (pr.labels || []).map((l) => l.name);
            const exempt = labels.includes("docs-not-needed");

            core.info(`Changed files: ${changed.length}`);
            core.info(`Code-changed files: ${codeChanged.length}`);
            core.info(`Doc-changed files: ${docChanged.length}`);
            core.info(`Labels: ${labels.join(", ") || "(none)"}`);

            const summarize = (items) => {
              if (!items.length) return "(none)";
              const first = items.slice(0, 20).map((p) => `- ${p}`).join("\n");
              const tail = items.length > 20 ? `\n- ... (+${items.length - 20} more)` : "";
              return `${first}${tail}`;
            };

            if (codeChanged.length > 0 && docChanged.length === 0 && !exempt) {
              const message = [
                "Docs Gate failed: code changes detected but no documentation updates were found.",
                "",
                "Detected code-changed paths:",
                summarize(codeChanged),
                "",
                "Detected doc-changed paths:",
                summarize(docChanged),
                "",
                "Update docs/ or README.md, or add label docs-not-needed with justification in PR description.",
              ].join("\n");
              core.setFailed(message);
              return;
            }

            core.info("Docs Gate passed.");

  lint:
    name: lint (ruff)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install ruff
        run: python -m pip install -U pip ruff

      - name: Ruff check
        run: ruff check .

      - name: Ruff format (check)
        run: ruff format --check .

  backend-tests:
    needs: lint
    runs-on: ubuntu-latest
    env:
      DJANGO_SECRET_KEY: ci-secret-key
      BRIDGE_API_KEY: ci-bridge-key
      DATABASE_URL: postgresql://myquant:myquant@postgres:5432/myquant
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build backend image
        run: docker compose build backend

      - name: Run backend tests
        run: |
          mkdir -p coverage
          docker compose run --rm \
            -v "$PWD/coverage:/app/coverage" \
            backend pytest -q --cov=. \
              --cov-report=term-missing \
              --cov-report=xml:/app/coverage/backend-coverage.xml

      - name: Upload backend coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: coverage/backend-coverage.xml
          if-no-files-found: error

  bridge-tests:
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"
          cache: "pip"
          cache-dependency-path: bridge/requirements.txt

      - name: Run bridge tests
        working-directory: bridge
        env:
          KIWOOM_BASE_URL: https://example.invalid
          KIWOOM_APP_KEY: dummy
          KIWOOM_APP_SECRET: dummy
          BACKEND_API_BASE: http://localhost:8000
          BRIDGE_API_KEY: dummy
        run: |
          python -m venv .venv
          ./.venv/bin/python -m pip install -U pip
          ./.venv/bin/python -m pip install -r requirements.txt
          mkdir -p ../coverage
          PYTHONPATH=src ./.venv/bin/python -m pytest -q \
            --cov=src \
            --cov-report=term-missing \
            --cov-report=xml:../coverage/bridge-coverage.xml

      - name: Upload bridge coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: bridge-coverage
          path: coverage/bridge-coverage.xml
          if-no-files-found: error

  coverage-summary:
    needs: [backend-tests, bridge-tests]
    runs-on: ubuntu-latest
    env:
      BACKEND_COV_MIN: "85"
      BRIDGE_COV_MIN: "55"
    steps:
      - name: Download backend coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage
          path: artifacts/backend

      - name: Download bridge coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: bridge-coverage
          path: artifacts/bridge

      - name: Upload combined coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-artifacts
          path: artifacts
          if-no-files-found: error

      - name: Publish coverage summary
        id: coverage_summary
        run: |
          python - <<'PY'
          import os
          import xml.etree.ElementTree as ET

          def read_pct(path: str) -> float:
              if not os.path.exists(path):
                  raise FileNotFoundError(f"Coverage XML not found: {path}")
              root = ET.parse(path).getroot()
              return float(root.attrib.get("line-rate", "0")) * 100.0

          backend_path = "artifacts/backend/backend-coverage.xml"
          bridge_path = "artifacts/bridge/bridge-coverage.xml"
          backend_pct = read_pct(backend_path)
          bridge_pct = read_pct(bridge_path)

          backend_min = float(os.getenv("BACKEND_COV_MIN", "85"))
          bridge_min = float(os.getenv("BRIDGE_COV_MIN", "55"))

          backend_ok = backend_pct >= backend_min
          bridge_ok = bridge_pct >= bridge_min
          overall_ok = backend_ok and bridge_ok
          overall_text = "PASS" if overall_ok else "FAIL"

          with open(os.environ["GITHUB_STEP_SUMMARY"], "a", encoding="utf-8") as fh:
              fh.write("## Coverage Summary\n")
              fh.write("\n")
              fh.write("| Component | Total Coverage | Minimum | Result |\n")
              fh.write("|---|---:|---:|---|\n")
              fh.write(
                  f"| Backend | {backend_pct:.2f}% | {backend_min:.2f}% | {'PASS' if backend_ok else 'FAIL'} |\n"
              )
              fh.write(
                  f"| Bridge | {bridge_pct:.2f}% | {bridge_min:.2f}% | {'PASS' if bridge_ok else 'FAIL'} |\n"
              )
              fh.write("\n")
              fh.write(f"**OVERALL: {overall_text}**\n")
              fh.write(f"- Backend XML: `{backend_path}`\n")
              fh.write(f"- Bridge XML: `{bridge_path}`\n")

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as out:
              out.write(f"backend_pct={backend_pct:.2f}\n")
              out.write(f"bridge_pct={bridge_pct:.2f}\n")
              out.write(f"backend_min={backend_min:.2f}\n")
              out.write(f"bridge_min={bridge_min:.2f}\n")
              out.write(f"backend_status={'PASS' if backend_ok else 'FAIL'}\n")
              out.write(f"bridge_status={'PASS' if bridge_ok else 'FAIL'}\n")
              out.write(f"overall_status={overall_text}\n")

          PY

      - name: Upsert PR coverage comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          BACKEND_PCT: ${{ steps.coverage_summary.outputs.backend_pct }}
          BRIDGE_PCT: ${{ steps.coverage_summary.outputs.bridge_pct }}
          BACKEND_MIN: ${{ steps.coverage_summary.outputs.backend_min }}
          BRIDGE_MIN: ${{ steps.coverage_summary.outputs.bridge_min }}
          BACKEND_STATUS: ${{ steps.coverage_summary.outputs.backend_status }}
          BRIDGE_STATUS: ${{ steps.coverage_summary.outputs.bridge_status }}
          OVERALL_STATUS: ${{ steps.coverage_summary.outputs.overall_status }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const marker = "<!-- myquant-coverage-summary -->";
            const issue_number = context.payload.pull_request?.number;
            if (!issue_number) {
              core.info("No pull_request context; skipping coverage comment.");
              return;
            }

            const body = `${marker}
            ### Coverage Summary

            | component | coverage | threshold | status |
            |---|---:|---:|---|
            | backend | ${process.env.BACKEND_PCT}% | ${process.env.BACKEND_MIN}% | ${process.env.BACKEND_STATUS} |
            | bridge | ${process.env.BRIDGE_PCT}% | ${process.env.BRIDGE_MIN}% | ${process.env.BRIDGE_STATUS} |

            **OVERALL: ${process.env.OVERALL_STATUS}**

            Coverage files are available as workflow artifacts.`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              per_page: 100,
            });

            const existing = comments.find(
              (c) => c.user?.type === "Bot" && c.body?.includes(marker),
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
              core.info(`Updated coverage comment: ${existing.id}`);
            } else {
              const created = await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number,
                body,
              });
              core.info(`Created coverage comment: ${created.data.id}`);
            }

      - name: Enforce coverage thresholds
        if: steps.coverage_summary.outputs.overall_status != 'PASS'
        run: |
          echo "Coverage thresholds not met:"
          echo "backend=${{ steps.coverage_summary.outputs.backend_pct }}% (min ${{ steps.coverage_summary.outputs.backend_min }}%)"
          echo "bridge=${{ steps.coverage_summary.outputs.bridge_pct }}% (min ${{ steps.coverage_summary.outputs.bridge_min }}%)"
          exit 1
